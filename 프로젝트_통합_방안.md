# 프로젝트 통합 방안: Company_Data 통합 프로젝트

## 1. 통합 목표 및 원칙

### 1.1 통합 목표

세 개의 프로젝트(Company_Data, Company_Data_3, Company_Data_5)를 하나의 통합 프로젝트로 병합하여:
- **최고의 아키텍처 채택**: Company_Data_5의 Agent 기반 아키텍처를 기본으로 사용
- **기능 통합**: 각 프로젝트의 우수한 기능들을 통합
- **코드 중복 제거**: 공통 기능을 하나의 모듈로 통합
- **유지보수성 향상**: 단일 코드베이스로 관리 복잡도 감소
- **확장성 확보**: 새로운 기능 추가가 용이한 구조

### 1.2 통합 원칙

1. **Agent 기반 아키텍처 우선**: Company_Data_5의 Agent 기반 구조를 기본 아키텍처로 채택
2. **점진적 통합**: 단계별로 안전하게 통합하여 기존 기능 유지
3. **하위 호환성**: 기존 데이터 및 설정 파일 호환성 유지
4. **최소 침습적**: 기존 동작을 최대한 보존하면서 개선
5. **문서화 우선**: 통합 과정의 모든 변경사항 문서화

---

## 2. 통합 아키텍처 설계

### 2.1 기본 아키텍처: Agent 기반 (Company_Data_5)

**선택 이유**:
- 가장 확장 가능하고 유지보수가 용이한 구조
- Function-calling 기반 표준화된 인터페이스
- 에이전트 레지스트리 시스템으로 자동 관리
- 워크플로우 엔진으로 복잡한 프로세스 처리 가능

### 2.2 통합된 에이전트 구조

```
통합 프로젝트/
├── src/
│   ├── agents/
│   │   ├── main/                    # Main Agent (Company_Data_5 기반)
│   │   ├── basic_info/              # Basic Info Agent (Company_Data_5 기반)
│   │   ├── planner/                 # Search Planning Agent (Company_Data_5 기반)
│   │   ├── search/                  # Search Agents
│   │   │   ├── search_rag_agent.py  # SAR (Company_Data_5 기반)
│   │   │   ├── search_web_agent.py  # SAW (Company_Data_5 기반)
│   │   │   └── search_tavily_agent.py # Tavily 검색 (Company_Data 통합)
│   │   ├── insight/                 # Make Insight Agent (Company_Data_5 기반)
│   │   └── report/                  # Make Report Agent (Company_Data_5 기반)
│   ├── rag/                         # RAG 시스템 (Company_Data_5 기반)
│   ├── chains/                      # LangChain Chain (Company_Data 호환 레이어)
│   ├── modules/                     # 모듈 기반 레거시 지원 (Company_Data_3 호환)
│   └── shared/                      # 공통 모듈
```

### 2.3 아키텍처 통합 전략

#### 2.3.1 Agent 기반 (기본)
- **Company_Data_5의 Agent 구조를 기본으로 사용**
- 모든 새로운 기능은 Agent로 구현

#### 2.3.2 Chain 호환 레이어 (레거시 지원)
- **Company_Data의 Chain 구조를 Agent로 래핑**
- 기존 Chain 코드를 Agent 내부에서 호출 가능하도록 어댑터 제공
- 점진적 마이그레이션 지원

#### 2.3.3 모듈 호환 레이어 (레거시 지원)
- **Company_Data_3의 모듈을 Agent Tool로 변환**
- MainController 로직을 Main Agent로 통합
- 기존 모듈을 Tool로 래핑하여 호환성 유지

---

## 3. 기능 통합 계획

### 3.1 검색 엔진 통합

#### 현재 상태
- **Company_Data**: Tavily Search API (유료)
- **Company_Data_3**: DuckDuckGo Search (무료)
- **Company_Data_5**: DuckDuckGo Search (무료)

#### 통합 방안
```
Search Agent - WEB (SAW) 확장
├── 기본: DuckDuckGo Search (무료)
├── 옵션 1: Tavily Search API (유료, 고품질)
└── 옵션 2: 다중 검색 엔진 병렬 실행 후 결과 통합
```

**구현 계획**:
1. SAW를 확장하여 검색 엔진 선택 가능하도록 수정
2. 설정 파일(`config/search_policy.json`)에 검색 엔진 우선순위 정의
3. Tavily Agent를 별도 Agent로 구현하되, SAW와 통합 인터페이스 제공
4. 검색 결과 품질 비교 및 자동 선택 기능 추가

### 3.2 RAG 시스템 통합

#### 현재 상태
- **Company_Data**: 단일 RAG (Slides)
- **Company_Data_3**: 단일 RAG (Slides)
- **Company_Data_5**: 이중 RAG (Notes + Slides, 라우팅 엔진)

#### 통합 방안
```
통합 RAG 시스템 (Company_Data_5 기반)
├── Notes RAG: 노츠 내부 문서 (SPA, MIA용)
├── Slides RAG: 회사소개서 슬라이드 (SAR용)
└── 라우팅 엔진: 메타데이터 기반 자동 분류
```

**구현 계획**:
1. Company_Data_5의 RAG 라우팅 시스템을 기본으로 사용
2. Company_Data와 Company_Data_3의 슬라이드 데이터를 통합
3. ETL 파이프라인으로 자동 분류 및 인덱싱
4. 기존 벡터 저장소 마이그레이션 스크립트 제공

### 3.3 LLM 통합 전략

#### 현재 상태
- **Company_Data**: LangChain Chain
- **Company_Data_3**: LangChain LLM
- **Company_Data_5**: OpenAI 직접 (Function-calling)

#### 통합 방안
```
LLM 통합 레이어
├── 기본: OpenAI Function-calling (Company_Data_5)
├── 호환 레이어: LangChain Chain → Agent 변환
└── 설정: LLM_PROVIDER 환경변수로 선택 가능
```

**구현 계획**:
1. 기본은 OpenAI Function-calling 사용
2. LangChain Chain을 Agent로 래핑하는 어댑터 제공
3. 필요시 LangChain 기반 Agent도 지원하도록 확장 가능한 구조
4. 프롬프트 관리 통합: Company_Data의 prompts/ 폴더 구조를 Agent별로 재구성

### 3.4 보고서 생성 통합

#### 현재 상태
- **Company_Data**: HTML 보고서 (Jinja2 템플릿)
- **Company_Data_3**: HTML 보고서 (Jinja2 템플릿)
- **Company_Data_5**: HTML 보고서 (Jinja2 템플릿)

#### 통합 방안
```
통합 보고서 생성 시스템
├── 템플릿 통합: 최고의 템플릿 선택 및 개선
├── 단계별 저장 옵션: Company_Data 방식 지원
├── 통합 저장 옵션: Company_Data_3/5 방식 지원
└── 다중 형식 지원: JSON, HTML, PDF (향후)
```

**구현 계획**:
1. 세 프로젝트의 템플릿을 비교하여 최고의 템플릿 선택
2. Company_Data의 단계별 저장 기능을 옵션으로 제공
3. 보고서 생성 Agent(MRA)에 저장 방식 선택 기능 추가
4. 템플릿 커스터마이징 기능 제공

### 3.5 로깅 및 모니터링 통합

#### 현재 상태
- **Company_Data**: 기본 logging + LangSmith
- **Company_Data_3**: Rich Handler
- **Company_Data_5**: Structlog (구조화된 로깅)

#### 통합 방안
```
통합 로깅 시스템
├── 기본: Structlog (구조화된 로깅)
├── 콘솔 출력: Rich Handler (사용자 친화적)
├── 파일 로깅: JSON 형식 (분석 용이)
└── 모니터링: LangSmith 통합 (토큰 추적)
```

**구현 계획**:
1. Structlog를 기본으로 사용하되 Rich Handler로 콘솔 출력
2. LangSmith 통합 유지 (Company_Data의 토큰 추적 기능)
3. 로그 레벨 및 출력 형식 설정 가능
4. 에러 추적 및 성능 모니터링 통합

### 3.6 설정 관리 통합

#### 현재 상태
- **Company_Data**: user.env (환경변수만)
- **Company_Data_3**: env.user + Settings 클래스
- **Company_Data_5**: env.user + ConfigManager + JSON/YAML

#### 통합 방안
```
통합 설정 관리 시스템
├── 환경변수: env.user (기본)
├── 설정 클래스: ConfigManager (Company_Data_5 기반)
├── 정책 파일: config/*.json, *.yaml
└── 검증: Pydantic 스키마
```

**구현 계획**:
1. Company_Data_5의 ConfigManager를 기본으로 사용
2. 모든 환경변수를 env.user로 통합
3. 정책 파일 구조 유지 (rag_routing.json, search_policy.json 등)
4. 설정 검증 및 기본값 제공

---

## 4. 데이터 통합 계획

### 4.1 데이터 소스 통합

```
통합 데이터 구조
data/
├── opendart/                    # DART 데이터 (통합)
│   ├── corpCode.xml
│   └── 한국표준산업분류(11차)표.xlsx
├── slides/                      # 슬라이드 JSON (통합)
│   └── [모든 슬라이드 JSON 파일]
├── company_info/                # 회사소개서 원본 (Company_Data)
│   ├── [노츠]회사소개서.pdf
│   └── [노츠]회사소개서.pptx
└── vector_db/                   # 벡터 데이터베이스
    ├── notes_rag/               # Notes RAG 인덱스
    └── slides_rag/              # Slides RAG 인덱스
```

### 4.2 벡터 저장소 마이그레이션

**마이그레이션 계획**:
1. 기존 벡터 저장소 백업
2. ETL 파이프라인으로 재인덱싱
3. 라우팅 규칙 적용하여 Notes/Slides RAG 분리
4. 마이그레이션 검증 스크립트 실행

### 4.3 결과 파일 통합

```
통합 출력 구조
output/
├── json/                        # JSON 결과
│   ├── 단계별/                  # Company_Data 방식 (옵션)
│   └── 통합/                    # Company_Data_3/5 방식 (기본)
├── html/                        # HTML 보고서
├── logs/                        # 구조화된 로그
└── rag/                         # RAG 관련 출력
```

---

## 5. 코드 통합 전략

### 5.1 통합 우선순위

#### Phase 1: 기반 구조 통합 (1-2주)
1. Company_Data_5의 기본 구조를 통합 프로젝트로 복사
2. 디렉토리 구조 정리 및 통합
3. 설정 관리 시스템 통합
4. 로깅 시스템 통합

#### Phase 2: 핵심 기능 통합 (2-3주)
1. 검색 엔진 통합 (DuckDuckGo + Tavily)
2. RAG 시스템 통합 및 마이그레이션
3. 데이터 소스 통합
4. 기본 Agent 기능 검증

#### Phase 3: 고급 기능 통합 (2-3주)
1. Chain 호환 레이어 구현 (Company_Data)
2. 모듈 호환 레이어 구현 (Company_Data_3)
3. 보고서 생성 통합
4. 단계별 저장 기능 추가

#### Phase 4: 테스트 및 최적화 (1-2주)
1. 통합 테스트 작성
2. 성능 테스트 및 최적화
3. 문서화 완료
4. 마이그레이션 가이드 작성

### 5.2 코드 통합 방법

#### 5.2.1 Agent로 변환 (Company_Data Chain)
```python
# Company_Data의 Chain을 Agent Tool로 변환
class ChainAdapterTool(BaseTool):
    """LangChain Chain을 Agent Tool로 변환"""
    def __init__(self, chain):
        self.chain = chain
    
    def execute(self, input_data):
        return self.chain.invoke(input_data)
```

#### 5.2.2 모듈을 Tool로 변환 (Company_Data_3)
```python
# Company_Data_3의 모듈을 Agent Tool로 변환
class ModuleAdapterTool(BaseTool):
    """모듈을 Agent Tool로 변환"""
    def __init__(self, module):
        self.module = module
    
    def execute(self, input_data):
        return self.module.process(input_data)
```

#### 5.2.3 기능 통합 예시: 검색 Agent
```python
# 통합된 Search Agent
class UnifiedSearchAgent(BaseAgent):
    """통합 검색 Agent (DuckDuckGo + Tavily)"""
    
    def __init__(self):
        self.ddgs_searcher = DuckDuckGoSearcher()
        self.tavily_searcher = TavilySearcher()  # Company_Data에서 통합
    
    def search(self, query, engine="auto"):
        if engine == "auto":
            # 설정에 따라 자동 선택
            engine = self.config.get_preferred_engine()
        
        if engine == "tavily":
            return self.tavily_searcher.search(query)
        else:
            return self.ddgs_searcher.search(query)
```

---

## 6. 의존성 통합

### 6.1 통합된 requirements.txt

```python
# 통합 프로젝트 의존성
# Python 3.11.9

# LLM 및 AI
openai>=1.12.0
langchain>=0.3.27          # 호환 레이어용
langchain-openai>=0.3.32   # 호환 레이어용
langchain-community>=0.3.28

# 벡터 저장소
chromadb>=0.4.22
faiss-cpu>=1.12.0

# 검색 엔진
ddgs>=0.1.0                # DuckDuckGo (기본)
tavily-python>=0.7.10      # Tavily (옵션)

# 데이터 처리
pandas>=2.1.0
openpyxl>=3.1.2
lxml>=4.9.3
beautifulsoup4>=4.13.5

# 웹 및 HTTP
requests>=2.31.0
httpx>=0.26.0

# 로깅 및 모니터링
structlog>=23.2.0          # 구조화된 로깅
rich>=13.7.0               # 콘솔 출력
langsmith>=0.3.45          # 토큰 추적

# 템플릿
jinja2>=3.1.2

# 유틸리티
pydantic>=2.5.0            # 데이터 검증
python-dotenv>=1.0.0       # 환경변수
pyyaml>=6.0.1              # 설정 파일

# 테스트
pytest>=7.4.4
pytest-asyncio>=0.23.2
pytest-cov>=4.1.0

# 개발 도구
black>=23.12.1
flake8>=7.0.0
mypy>=1.8.0
```

### 6.2 선택적 의존성

- **Tavily**: 유료 검색 API 사용 시에만 필요
- **LangSmith**: 토큰 추적 사용 시에만 필요
- **LangChain**: 호환 레이어 사용 시에만 필요

---

## 7. 설정 파일 통합

### 7.1 통합된 env.user 구조

```bash
# LLM 설정
OPENAI_API_KEY=your_api_key
LLM_MODEL_DEFAULT=gpt-4o-mini
LLM_PROVIDER=openai  # openai, langchain

# 검색 엔진 설정
SEARCH_ENGINE_DEFAULT=ddgs  # ddgs, tavily, auto
TAVILY_API_KEY=your_tavily_key  # 선택적

# DART API
DART_API_KEY=your_dart_key

# RAG 설정
RAG_EMBEDDING_MODEL=text-embedding-3-small
RAG_VECTOR_STORE=chroma  # chroma, faiss

# 로깅 설정
LOG_LEVEL=INFO
LOG_FORMAT=json  # json, rich
LANGSMITH_TRACING=true  # 선택적
LANGSMITH_API_KEY=your_langsmith_key  # 선택적

# 출력 설정
OUTPUT_FORMAT=both  # json, html, both
SAVE_STAGES=true  # Company_Data 방식 단계별 저장
```

### 7.2 통합된 config/ 구조

```
config/
├── rag_routing.json          # RAG 라우팅 규칙 (Company_Data_5)
├── search_policy.json         # 검색 정책 (Company_Data_5)
├── spa_strategy.json          # 전략 설정 (Company_Data_5)
├── logging.yaml               # 로깅 설정 (Company_Data_5)
└── chain_compatibility.json   # Chain 호환 설정 (신규)
```

---

## 8. 마이그레이션 계획

### 8.1 데이터 마이그레이션

#### 8.1.1 벡터 저장소 마이그레이션
```bash
# 마이그레이션 스크립트 실행
python scripts/migrate_vector_store.py \
    --source Company_Data/vector_store \
    --target output/rag/ \
    --routing-config config/rag_routing.json
```

#### 8.1.2 결과 파일 마이그레이션
```bash
# 결과 파일 통합 스크립트
python scripts/migrate_results.py \
    --source-dirs Company_Data/results Company_Data_3/result Company_Data_5/output \
    --target output/
```

### 8.2 코드 마이그레이션

#### 8.2.1 단계별 마이그레이션 가이드

**Step 1: 기반 구조 설정**
1. Company_Data_5를 통합 프로젝트 기본으로 복사
2. 디렉토리 구조 정리
3. 기본 설정 파일 통합

**Step 2: 데이터 통합**
1. 모든 데이터 소스를 `data/`로 통합
2. 벡터 저장소 마이그레이션
3. 설정 파일 통합

**Step 3: 기능 통합**
1. 검색 엔진 통합
2. RAG 시스템 통합
3. 보고서 생성 통합

**Step 4: 호환 레이어 추가**
1. Chain 호환 레이어 구현
2. 모듈 호환 레이어 구현
3. 기존 코드 호환성 테스트

**Step 5: 테스트 및 문서화**
1. 통합 테스트 작성
2. 마이그레이션 가이드 작성
3. 사용자 가이드 업데이트

### 8.3 마이그레이션 검증

#### 검증 체크리스트
- [ ] 모든 기존 기능이 통합 프로젝트에서 동작
- [ ] 데이터 마이그레이션 완료 및 검증
- [ ] 설정 파일 통합 및 검증
- [ ] 테스트 통과
- [ ] 성능 저하 없음
- [ ] 문서화 완료

---

## 9. 통합 후 프로젝트 구조

### 9.1 최종 디렉토리 구조

```
unified_company_data/
├── src/
│   ├── agents/                  # LLM Agents (Company_Data_5 기반)
│   │   ├── main/
│   │   ├── basic_info/
│   │   ├── planner/
│   │   ├── search/
│   │   │   ├── search_rag_agent.py
│   │   │   ├── search_web_agent.py
│   │   │   └── search_tavily_agent.py  # 신규
│   │   ├── insight/
│   │   └── report/
│   ├── rag/                     # RAG 시스템 (Company_Data_5 기반)
│   │   ├── etl/
│   │   ├── routing/
│   │   └── search/
│   ├── chains/                  # Chain 호환 레이어 (Company_Data)
│   │   └── adapters/
│   ├── modules/                 # 모듈 호환 레이어 (Company_Data_3)
│   │   └── adapters/
│   ├── registry/                # 에이전트 레지스트리 (Company_Data_5)
│   ├── shared/                  # 공통 모듈
│   │   ├── core/
│   │   ├── models/
│   │   └── utils/
│   └── config/                  # 설정 관리 (Company_Data_5 기반)
│
├── config/                      # 설정 파일
│   ├── rag_routing.json
│   ├── search_policy.json
│   ├── spa_strategy.json
│   └── logging.yaml
│
├── data/                        # 통합 데이터
│   ├── opendart/
│   ├── slides/
│   ├── company_info/
│   └── vector_db/
│
├── output/                      # 통합 출력
│   ├── json/
│   ├── html/
│   ├── logs/
│   └── rag/
│
├── docs/                        # 통합 문서
│   ├── integration_guide.md     # 통합 가이드
│   ├── migration_guide.md       # 마이그레이션 가이드
│   ├── architecture.md          # 아키텍처 문서
│   └── api_reference.md         # API 참조
│
├── scripts/                     # 유틸리티 스크립트
│   ├── migrate_vector_store.py
│   ├── migrate_results.py
│   └── validate_integration.py
│
├── tests/                       # 통합 테스트
│   ├── unit/
│   ├── integration/
│   └── agents/
│
├── main.py                      # 메인 진입점
├── env.user                     # 환경변수
├── env.user.template            # 환경변수 템플릿
├── pyproject.toml               # 프로젝트 설정
├── requirements.txt             # 의존성
└── README.md                    # 통합 README
```

### 9.2 주요 변경사항 요약

1. **아키텍처**: Agent 기반으로 통일 (Company_Data_5)
2. **검색 엔진**: DuckDuckGo 기본, Tavily 옵션
3. **RAG 시스템**: 이중 RAG (Notes + Slides) + 라우팅
4. **로깅**: Structlog + Rich + LangSmith
5. **설정 관리**: ConfigManager + JSON/YAML
6. **출력 형식**: 통합 JSON + HTML, 단계별 저장 옵션

---

## 10. 리스크 및 대응 방안

### 10.1 주요 리스크

#### 리스크 1: 기존 기능 호환성 문제
- **확률**: 중간
- **영향**: 높음
- **대응**: 호환 레이어 구현, 단계적 마이그레이션

#### 리스크 2: 데이터 마이그레이션 실패
- **확률**: 낮음
- **영향**: 높음
- **대응**: 백업 필수, 검증 스크립트 제공

#### 리스크 3: 성능 저하
- **확률**: 낮음
- **영향**: 중간
- **대응**: 성능 테스트, 최적화

#### 리스크 4: 문서화 부족
- **확률**: 낮음
- **영향**: 중간
- **대응**: 통합 과정 문서화, 마이그레이션 가이드 작성

### 10.2 완화 전략

1. **단계적 통합**: 한 번에 모든 것을 통합하지 않고 단계별로 진행
2. **백업 필수**: 모든 데이터와 설정 파일 백업
3. **테스트 우선**: 각 단계마다 충분한 테스트
4. **롤백 계획**: 문제 발생 시 이전 상태로 복구 가능하도록 준비

---

## 11. 예상 일정

### 11.1 통합 일정 (총 8-10주)

| Phase | 기간 | 주요 작업 |
|-------|------|-----------|
| Phase 1: 기반 구조 | 1-2주 | 구조 통합, 설정 통합 |
| Phase 2: 핵심 기능 | 2-3주 | 검색, RAG, 데이터 통합 |
| Phase 3: 고급 기능 | 2-3주 | 호환 레이어, 보고서 통합 |
| Phase 4: 테스트 | 1-2주 | 테스트, 문서화, 최적화 |

### 11.2 마일스톤

- **M1 (2주)**: 기반 구조 통합 완료
- **M2 (5주)**: 핵심 기능 통합 완료
- **M3 (8주)**: 모든 기능 통합 완료
- **M4 (10주)**: 테스트 및 문서화 완료, 릴리스 준비

---

## 12. 다음 단계

### 12.1 즉시 시작 가능한 작업

1. **통합 프로젝트 기본 구조 생성**
   - Company_Data_5를 기본으로 복사
   - 디렉토리 구조 정리

2. **설정 파일 통합**
   - env.user 통합
   - config/ 파일 통합

3. **데이터 소스 통합**
   - data/ 폴더 통합
   - 중복 제거

### 12.2 승인 필요 작업

1. **아키텍처 결정**: Agent 기반 아키텍처 채택 승인
2. **검색 엔진 전략**: Tavily 통합 여부 결정
3. **마이그레이션 일정**: 단계별 일정 승인

---

## 13. 참고 자료

### 13.1 관련 문서
- `폴더_분석_결과.md`: 세 프로젝트 상세 분석
- Company_Data_5/docs/: Phase별 설계 문서
- Company_Data/docs/specs/: 요구사항 및 설계 문서

### 13.2 주요 파일 위치
- **Company_Data**: `src/company_info_collector.py`, `src/llm/chains/`
- **Company_Data_3**: `modules/main_controller.py`, `modules/`
- **Company_Data_5**: `src/agents/`, `src/rag/`, `src/registry/`

---

**작성일**: 2025-01-XX  
**작성자**: AI Assistant  
**버전**: 1.0  
**상태**: 초안

